# Media Toolkit

**Media Toolkit** — это универсальное десктопное приложение на Python (tkinter), объединяющее в себе необходимые инструменты для повседневной работы с медиафайлами.

Приложение создавалось с целью собрать рутинные задачи в одном удобном интерфейсе: скачивание видео, конвертация форматов, сжатие, обрезка и склейка файлов. Под капотом программа работает как графическая оболочка (GUI) для двух инструментов: **yt-dlp** и **FFmpeg**.

## Структура проекта

Архитектура приложения построена по модульному принципу, четко разделяя графический интерфейс (frontend) и логику (backend).

```text
folder/
├── bin/                       # Папка для внешних инструментов (зависимости)
│   ├── ffmpeg.exe             # Бинарник для обработки видео/аудио
│   ├── ffprobe.exe            # Бинарник для анализа метаданных
│   └── ffplay.exe             # Используется для предпросмотра в редакторе
│
├── src/                       # Исходный код приложения
│   │
│   ├── core/                  # ЯДРО: Чистая логика (backend)
│   │   ├── __init__.py
│   │   ├── compressor_logic.py # Логика сжатия (управление CRF, разрешение)
│   │   ├── converter_logic.py  # Логика конвертации (Smart Stream Copy)
│   │   ├── downloader_logic.py # Обертка над yt-dlp с хуками прогресса
│   │   ├── editor_logic.py     # Обработка waveform, trim и предпросмотр
│   │   └── merger_logic.py     # Логика склейки (concat demuxer / filter complex)
│   │
│   ├── tabs/                  # ИНТЕРФЕЙС: Вкладки (frontend)
│   │   ├── __init__.py
│   │   ├── base_tab.py         # Базовый класс (общая консоль, потоки)
│   │   ├── about_tab.py        # Дополнительная информация внутри приложения
│   │   ├── compressor_tab.py   # UI сжатия (Single/Batch)
│   │   ├── converter_tab.py    # UI конвертации (Single/Batch)
│   │   ├── downloader_tab.py   # UI загрузчика
│   │   ├── editor_tab.py       # Визуальный редактор (Timeline, Canvas)
│   │   └── merger_tab.py       # Менеджер очереди файлов для склейки
│   │
│   ├── utils/                 # УТИЛИТЫ
│   │   ├── __init__.py
│   │   ├── ffmpeg_utils.py     # Поиск и валидация бинарников FFmpeg
│   │   ├── theme.py            # Стилизация (цвета, шрифты, ttk styles)
│   │   └── updater.py          # Авто-обновление yt-dlp через pip
│   │
│   └── main.py                # ТОЧКА ВХОДА: Инициализация и запуск
│
├── requirements.txt           # Список Python-зависимостей
└── README.md                  
```

## Функционал и особенности модулей

Главная особенность архитектуры — многопоточность. Каждая вкладка запускает свои задачи в отдельном потоке, благодаря чему интерфейс не зависает даже при рендеринге тяжелого видео. Для обратной связи с пользователем везде реализована встроенная консоль, выводящая логи в реальном времени.

### 1. Downloader (Загрузчик)
Это удобная графическая надстройка над библиотекой `yt-dlp`. Модуль позволяет скачивать контент в двух режимах: полноценное видео (где программа сама скачивает видео и аудио потоки в максимальном качестве и склеивает их) или экстракция только аудиодорожки.

Некоторое внимание мелочам:
*   **Защита от дублей:** Программа "на лету" запоминает ссылки, которые сейчас в работе. Вы не сможете случайно запустить скачивание одного и того же ролика дважды. (К сожалению, это проверка не позволяет скачивать аудио и видео с одной и той же ссылки одновременно).
*   **Проверка файлов:** Если файл с таким именем уже существует в папке назначения, загрузка будет пропущена (если явно не включена опция перезаписи), чтобы сэкономить ваше время и трафик.
*   **Авто-обновление:** При каждом запуске программа тихо проверяет наличие свежей версии `yt-dlp` и обновляет её, так что вам не страшны изменения алгоритмов YouTube.
*   **Cancel кнопка:** При ее нажатии отменяются все процессы загрузки и удаляются временные файлы, но файл с окончанием `f616.[format].part` иногда не хочет удаляться. Это не страшно. В таком случае просто закройте программу и удалите файл в ручную.

### 2. Converter (Конвертер)
Инструмент для смены контейнеров и кодеков. Он поддерживает как одиночную работу с файлом, так и пакетную обработку целых папок (Batch mode).

Здесь реализована "умная логика" (Smart Logic):
*   Если вы пытаетесь перегнать файл в тот же самый формат (например, MKV -> MKV), программа не будет перекодировать видео, а использует `Stream Copy`. Это происходит мгновенно и без потери качества.
*   При смене формата применяются заранее настроенные, оптимальные пресеты (H.264 для видео, AAC/LAME для аудио), балансирующие между размером и качеством.
*   Присутствует защита перезаписи исходника: программа не даст вам начать конвертацию, если входной и выходной файлы совпадают, предотвращая повреждение исходника.

### 3. Compressor (Сжатие)
Модуль для уменьшения веса видеофайлов, основанный на параметре **CRF** (Constant Rate Factor). Вместо того чтобы гадать с битрейтом, вы просто двигаете ползунок от 0 (Lossless) до 51 (минимальное качество), выбирая нужный баланс.

Особенности:
*   Поддержка изменения разрешения (Resize) прямо во время сжатия.
*   Пакетный режим: можно сжать вес целой папки с видео за один раз.
*   Безопасность: если путь сохранения не выбран, программа сама создаст подпапку `compressed`, чтобы не смешивать оригиналы и сжатые версии. Также реализована защита от перезаписи исходников.

### 4. Editor / Cutter (Редактор)
Полноценный инструмент для нарезки. В отличие от простых каттеров, здесь вы видите визуализацию звуковой волны (waveform), что позволяет резать видео с хирургической точностью — по звуковым пикам или паузам.

*   **Интерфейс:** Таймлайн с поддержкой зума (колесиком мыши) и панорамирования (через ПКМ).
*   **Предпросмотр:** Встроенный плеер позволяет прослушать и просмотреть выделенный участок перед экспортом. (будьте аккуратны с паузами, ведь при их использовании происходит малое смещение воспроизведения звука, однако границы диапазона нарезки не смещаются и файл будет обрезан как надо).
*   **Технический нюанс:** Многие редакторы просто режут поток (`copy`), из-за чего в начале видео часто появляются черные кадры или рассинхрон, так как разрез не попадает в ключевой кадр (I-frame). Был реализован другой путь: редактор использует быстрое перекодирование (`preset ultrafast`) со сбросом таймстампов. Это гарантирует, что видео начнется ровно с той миллисекунды, которую вы выбрали. [Подробнее можете в коде комментарии посмотреть] 

### 5. Merger (Склейка)
Инструмент для соединения множества файлов в один длинный трек. Работает как с видео, так и с чистым аудио.

*   **Очередь файлов:** Удобный список, где можно менять порядок роликов местами.
*   **Умная подгонка:** Если вы пытаетесь склеить видео разных размеров (например, 1080p и 720p (В случае необходимости в коде вы можете добавить другие разрешения)), программа автоматически приведет их к общему знаменателю, добавив черные полосы (padding) там, где это необходимо, чтобы итоговое видео не "прыгало".
*   **Фон для аудио:** При склейке аудиофайлов можно подложить статичную картинку, получив на выходе видеофайл.

---

## Настройка кодеков (Developer Guide)

В коде уже выставлены сбалансированные настройки FFmpeg, подходящие для большинства задач. Однако, если вам нужно изменить кодеки, битрейт или пресеты качества, это легко сделать.

Для удобства навигации по коду используйте поиск (Ctrl+F) по специальным маркерам, указанным ниже.
Если текст строки не помещается в екран, то используейте Ctrl+Shift+P: toggle word wrap (VS Code)

#### 1. Конвертация (`src/core/converter_logic.py`)
Ищите по маркеру: `-(Settings)-`
В этом блоке (метод `run_convert`) находится логика выбора кодеков.
*   Вы можете изменить `crf_value` (по умолчанию 23-28) для настройки качества.
*   Для ускорения кодирования можно поменять `preset` с `slow` на `fast` или `ultrafast`.
*   Здесь же задается битрейт аудио (например, `-b:a 128k`).

#### 2. Сжатие (`src/core/compressor_logic.py`)
Ищите по маркеру: `-(Settings)-`
(Метод `run_compress`).
*   Здесь определяется логика работы слайдера CRF.
*   Обратите внимание на настройки для `.webm` — там используется кодек VP9, который работает иначе, чем H.264.

#### 3. Редактор (`src/core/editor_logic.py`)
Ищите по маркеру: `-(Settings)-`
(Метод `run_cut`).
*   Здесь задаются параметры перекодирования вырезанного фрагмента.
*   **Важно:** Мы используем флаги `-c:v libx264` и `-preset ultrafast`. Если вы хотите резать без перекодирования (мгновенно, но менее точно), замените их на `-c:v copy`.
*   **Аудио:** Если вы уберете фильтр громкости и поставите `-c:a copy`, звук будет копироваться как есть, но ползунок громкости в интерфейсе перестанет влиять на результат.

#### 4. Объединитель (`src/core/merger_logic.py`)
Ищите по маркеру: `-(Settings)-`
(Метод `run_merge`).
*   Блок разделен на `VIDEO MODE` и `AUDIO MODE`.
*   В видео-режиме используется сложный `filter_complex` для масштабирования и паддинга. Будьте осторожны при его редактировании.
*   Здесь можно изменить качество финальной склейки, поправив параметры `-crf` и `-preset`.

---

## Установка и запуск

1.  **Требования:**
    *   Python 3.12+ (Проект тестировался на Python 3.14). Скачайте его с [официального сайта](https://www.python.org/downloads/).
    *   Установите необходимые библиотеки:
        ```bash
        pip install -r requirements.txt
        ```
2.  **FFmpeg:**
    *   Для работы программы необходим FFmpeg. Скачайте его с [официального сайта](https://ffmpeg.org/download.html).
    *   Поместите файлы `ffmpeg.exe`, `ffprobe.exe` (и для редактора `ffplay.exe`) в папку `bin/` в корне проекта.
    *   *Альтернатива:* Убедитесь, что FFmpeg установлен в вашей системе и добавлен в переменную окружения PATH. (И не забудьте перезагрузить компьютер, чтобы системные пути заработали).
3.  **Запуск:**
    ```bash
    python src/main.py
    ```
